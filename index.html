<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>1/4096 ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <meta name="theme-color" content="#0d0d0d" />
  <style>
    /* ===== ãƒ™ãƒ¼ã‚¹ ===== */
    :root {
      --bg: #0d0d0d;
      --fg: #f2f2f2;
      --muted: #bdbdbd;
      --accent: #2dd4bf; /* æˆåŠŸ */
      --danger: #ef4444; /* å¤±æ•— */
      --btn: #1a1a1a;
      --btnBorder: #2a2a2a;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN",
                   "Yu Gothic UI", "Yu Gothic", "Meiryo", sans-serif;
    }
    /* iOSã®100vhå•é¡Œå¯¾ç­–: svh=safe viewport height */
    .app {
      min-height: 100svh;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 12px;
      padding: calc(env(safe-area-inset-top) + 12px) 14px calc(env(safe-area-inset-bottom) + 14px);
      touch-action: manipulation;
      user-select: none;
    }

    /* ===== HUDï¼ˆä¸Šéƒ¨æƒ…å ±ï¼‰ ===== */
    .hud {
      display: grid;
      grid-template-columns: 1fr auto auto;
      align-items: center;
      gap: 10px;
      font-variant-numeric: tabular-nums;
    }
    .title {
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    .chip {
      border: 1px solid var(--btnBorder);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 14px;
      color: var(--muted);
    }

    /* ===== ãƒ¡ã‚¤ãƒ³è¡¨ç¤º ===== */
    .center {
      display: grid;
      place-items: center;
      text-align: center;
      gap: 12px;
    }
    .prob {
      font-size: clamp(28px, 15vw, 120px);
      font-weight: 800;
      letter-spacing: 0.02em;
      line-height: 1.05;
    }
    .subprob {
      color: var(--muted);
      font-size: clamp(14px, 4.5vw, 18px);
    }
    .streak {
      color: var(--muted);
      font-size: clamp(14px, 4.5vw, 18px);
    }

    /* ===== å·¨å¤§ãƒœã‚¿ãƒ³ ===== */
    .bigBtn {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: min(62vh, 62svh);
      border-radius: 20px;
      border: 2px solid var(--btnBorder);
      background:
        radial-gradient(120% 120% at 80% -10%, #222 0%, #161616 40%, #121212 70%, #101010 100%);
      color: var(--fg);
      font-size: clamp(24px, 8vw, 40px);
      font-weight: 800;
      letter-spacing: .04em;
      cursor: pointer;
      display: grid;
      place-items: center;
      text-transform: uppercase;
      box-shadow: 0 6px 18px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03);
      transition: transform .02s ease, filter .08s ease;
    }
    .bigBtn:active { transform: translateY(1px) scale(0.998); filter: brightness(1.02); }
    .hint { color: var(--muted); font-size: 13px; margin-top: 8px; }

    /* ===== ä¸‹éƒ¨æ“ä½œ ===== */
    .footer {
      display: flex; align-items: center; justify-content: space-between;
      gap: 8px; flex-wrap: wrap;
    }
    .btn {
      border: 1px solid var(--btnBorder);
      background: #131313;
      color: var(--fg);
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
    }
    .btn:active { transform: translateY(1px); }

    /* ===== ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ¼”å‡º ===== */
    .flash-success { animation: flashSuccess 160ms ease; }
    .flash-fail { animation: flashFail 180ms ease; }
    @keyframes flashSuccess {
      from { box-shadow: 0 0 0 0 rgba(45,212,191,0.0), 0 0 0 0 rgba(45,212,191,0.0) }
      50% { box-shadow: 0 0 0 6px rgba(45,212,191,0.22), 0 0 60px 10px rgba(45,212,191,0.18) }
      to { box-shadow: 0 0 0 0 rgba(45,212,191,0.0), 0 0 0 0 rgba(45,212,191,0.0) }
    }
    @keyframes flashFail {
      from { box-shadow: 0 0 0 0 rgba(239,68,68,0.0), 0 0 0 0 rgba(239,68,68,0.0) }
      50% { box-shadow: 0 0 0 6px rgba(239,68,68,0.22), 0 0 60px 10px rgba(239,68,68,0.18) }
      to { box-shadow: 0 0 0 0 rgba(239,68,68,0.0), 0 0 0 0 rgba(239,68,68,0.0) }
    }

    /* ===== å‹åˆ©ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ===== */
    .overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.7);
      display: none;
      align-items: center; justify-content: center;
      padding: 20px;
      z-index: 10;
      backdrop-filter: blur(2px);
    }
    .overlay.show { display: flex; }
    .modal {
      width: min(680px, 92vw);
      background: #101010;
      border: 1px solid var(--btnBorder);
      border-radius: 16px;
      padding: 18px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,.45);
    }
    .modal h2 { margin: 8px 0 6px; font-size: clamp(22px, 7vw, 28px); }
    .modal p { color: var(--muted); margin: 4px 0 10px; }
    .modal .actions { margin-top: 12px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }

    /* è¨¼æ˜/èª¬æ˜ã®details */
    details {
      margin-top: 10px;
      border: 1px solid var(--btnBorder);
      border-radius: 12px;
      padding: 10px 12px;
      color: var(--muted);
    }
    summary { cursor: pointer; color: var(--fg); font-weight: 600; }
    code { background: #151515; padding: 1px 6px; border-radius: 6px; }

  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- ä¸Šéƒ¨HUD -->
    <div class="hud">
      <div class="title">1/4096 ãƒãƒ£ãƒ¬ãƒ³ã‚¸</div>
      <div class="chip" id="attempts">è©¦è¡Œ: 0</div>
      <div class="chip" id="best">ãƒ™ã‚¹ãƒˆé€£ç¶š: 0</div>
    </div>

    <!-- ä¸­å¤®è¡¨ç¤ºã¨å·¨å¤§ãƒœã‚¿ãƒ³ -->
    <div class="center">
      <div class="prob" id="prob">1 / 2Â¹</div>
      <div class="subprob" id="probDetail">ç´„50.000%ï½œæ¬¡ã¯ 1/2 ã«æŒ‘æˆ¦</div>
      <div class="streak" id="streak">é€£ç¶šæˆåŠŸ: 0 / 12</div>

      <button class="bigBtn" id="tryBtn" aria-label="ã‚¿ãƒƒãƒ—ã—ã¦åˆ¤å®š">
        ã‚¿ãƒƒãƒ—ã§åˆ¤å®š
      </button>
      <div class="hint">æˆåŠŸã§æ®µéšã‚¢ãƒƒãƒ—ã€å¤±æ•—ã§æœ€åˆã‹ã‚‰ã€‚12é€£ç¶šæˆåŠŸã§ã‚¯ãƒªã‚¢ã€‚</div>
    </div>

    <!-- ä¸‹éƒ¨æ“ä½œ -->
    <div class="footer">
      <button class="btn" id="resetBtn">â†» ãƒªã‚»ãƒƒãƒˆ</button>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" id="soundBtn">ğŸ”Š åŠ¹æœéŸ³: ON</button>
        <button class="btn" id="vibeBtn">ğŸ“³ ãƒã‚¤ãƒ–: ON</button>
      </div>
    </div>
  </div>

  <!-- å‹åˆ©ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="overlay" id="winOverlay" role="dialog" aria-modal="true" aria-labelledby="winTitle">
    <div class="modal">
      <h2 id="winTitle">CLEAR! 1/4096 é”æˆ</h2>
      <p id="winStats">ç·ã‚¯ãƒªãƒƒã‚¯: 0ï½œçµŒéé€£ç¶š: 12ï½œãƒ™ã‚¹ãƒˆé€£ç¶š: 12</p>
      <div class="actions">
        <button class="btn" id="againBtn">ã‚‚ã†ä¸€åº¦</button>
        <button class="btn" id="shareBtn">çµæœã‚’å…±æœ‰</button>
      </div>
      <details>
        <summary>ã“ã®ã‚²ãƒ¼ãƒ ã®å…¬å¹³æ€§ï¼ˆåˆ¤å®šã®æ ¹æ‹ ï¼‰</summary>
        <p>æˆåŠŸåˆ¤å®šã¯ <code>crypto.getRandomValues</code> ã§ç”Ÿæˆã—ãŸ32ãƒ“ãƒƒãƒˆæ•´æ•° <code>X</code> ã‚’ç”¨ã„ã€æ¡ä»¶ <code>X &lt; 2Â³Â¹</code> ã‚’æˆåŠŸã¨ã™ã‚‹ã€‚<br>
           32ãƒ“ãƒƒãƒˆã®å–ã‚Šã†ã‚‹å€¤ã¯ 0..2Â³Â²âˆ’1 ã®ä¸€æ§˜åˆ†å¸ƒãªã®ã§ã€æˆåŠŸã¯ã¡ã‚‡ã†ã©åŠæ•°ï¼ˆ2Â³Â¹é€šã‚Šï¼‰ã«ãªã‚‹ã€‚ã‚ˆã£ã¦1å›ã”ã¨ã®æˆåŠŸç¢ºç‡ã¯å³å¯†ã« 1/2 ã ã€‚<br>
           é€£ç¶š12å›æˆåŠŸã®ç¢ºç‡ã¯ (1/2)Â¹Â² = 1/4096ã€‚é€”ä¸­ã§å¤±æ•—ã—ãŸå ´åˆã¯é€£ç¶šæ•°ãŒ0ã«æˆ»ã‚‹ã€‚
        </p>
      </details>
    </div>
  </div>

  <script>
    // ===== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ =====
    const TARGET_POW = 12; // 1/4096 = (1/2)^12
    let attempts = 0;      // ç·ã‚¯ãƒªãƒƒã‚¯æ•°
    let streak = 0;        // é€£ç¶šæˆåŠŸæ•°ï¼ˆ0..12ï¼‰
    let bestStreak = Number(localStorage.getItem('bestStreak') || 0);
    let clears = Number(localStorage.getItem('clears') || 0);

    // è¨­å®šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰
    let soundOn = (localStorage.getItem('soundOn') ?? '1') === '1';
    let vibeOn  = (localStorage.getItem('vibeOn')  ?? '1') === '1';

    // ===== DOMå–å¾— =====
    const probEl = document.getElementById('prob');
    const probDetailEl = document.getElementById('probDetail');
    const streakEl = document.getElementById('streak');
    const attemptsEl = document.getElementById('attempts');
    const bestEl = document.getElementById('best');
    const tryBtn = document.getElementById('tryBtn');
    const resetBtn = document.getElementById('resetBtn');
    const soundBtn = document.getElementById('soundBtn');
    const vibeBtn = document.getElementById('vibeBtn');

    const winOverlay = document.getElementById('winOverlay');
    const againBtn = document.getElementById('againBtn');
    const shareBtn = document.getElementById('shareBtn');
    const winStats = document.getElementById('winStats');

    // ===== ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª =====
    let audioCtx = null;
    function ensureAudio() {
      if (!soundOn) return;
      if (!audioCtx) {
        try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        catch (e) { audioCtx = null; }
      }
    }
    function beep(freq=880, ms=80, type='sine') {
      if (!soundOn || !audioCtx) return;
      const t0 = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, t0);
      osc.connect(gain).connect(audioCtx.destination);
      // çŸ­ã„ADSR
      gain.gain.setValueAtTime(0.0001, t0);
      gain.gain.exponentialRampToValueAtTime(0.25, t0 + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, t0 + ms/1000);
      osc.start(t0);
      osc.stop(t0 + ms/1000 + 0.02);
    }

    // ===== ä¹±æ•°ï¼ˆå³å¯†ãª1/2åˆ¤å®šï¼‰ =====
    function fairCoin() {
      // cryptoãŒã‚ã‚Œã° 32bitä¸€æ§˜æ•´æ•° â†’ X < 2^31 ã‚’æˆåŠŸã¨ã™ã‚‹ï¼ˆå³å¯†ã«1/2ï¼‰
      if (window.crypto && crypto.getRandomValues) {
        const a = new Uint32Array(1);
        crypto.getRandomValues(a);
        return (a[0] >>> 0) < 0x80000000; // 2^31
      }
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆMath.randomã¯å®Ÿè£…ä¾å­˜ã ãŒã€å®Ÿç”¨ä¸Šã¯ã»ã¼1/2ï¼‰
      return Math.random() < 0.5;
    }

    // ===== UIæ›´æ–° =====
    function pow2(n) { return 2 ** n; }
    function formatPercent(p) {
      if (p >= 1) return (p).toFixed(0) + '%';
      if (p >= 0.1) return p.toFixed(2) + '%';
      return p.toFixed(3) + '%';
    }
    function updateUI() {
      // æ¬¡ã«æŒ‘æˆ¦ã™ã‚‹æ®µéšã¯ 1 / 2^(streak+1)
      const nextPow = Math.min(streak + 1, TARGET_POW);
      const denom = pow2(nextPow);
      const percent = 100 / denom;

      probEl.textContent = `1 / 2^${nextPow}`;
      probDetailEl.textContent = `ç´„${formatPercent(percent)}ï½œæ¬¡ã¯ 1/${denom} ã«æŒ‘æˆ¦`;
      streakEl.textContent = `é€£ç¶šæˆåŠŸ: ${streak} / ${TARGET_POW}`;
      attemptsEl.textContent = `è©¦è¡Œ: ${attempts}`;
      bestEl.textContent = `ãƒ™ã‚¹ãƒˆé€£ç¶š: ${bestStreak}`;
      soundBtn.textContent = `ğŸ”Š åŠ¹æœéŸ³: ${soundOn ? 'ON' : 'OFF'}`;
      vibeBtn.textContent  = `ğŸ“³ ãƒã‚¤ãƒ–: ${vibeOn ? 'ON' : 'OFF'}`;

      document.title = (streak > 0 ? `é€£ç¶š${streak} â–¶ ` : '') + '1/4096 ãƒãƒ£ãƒ¬ãƒ³ã‚¸';
    }

    function flash(target, ok) {
      const cls = ok ? 'flash-success' : 'flash-fail';
      target.classList.remove('flash-success', 'flash-fail');
      // ãƒªãƒ•ãƒ­ãƒ¼ã§ã‚¢ãƒ‹ãƒ¡å†é©ç”¨
      void target.offsetWidth;
      target.classList.add(cls);
    }

    // ===== åˆ¤å®šå‡¦ç† =====
    function judgeOnce() {
      attempts++;
      ensureAudio();

      const ok = fairCoin();
      if (ok) {
        streak++;
        if (vibeOn && navigator.vibrate) navigator.vibrate(20);
        beep(900 + streak * 12, 70, 'triangle');
        flash(tryBtn, true);

        // ã‚¯ãƒªã‚¢æ¡ä»¶: 12é€£ç¶šæˆåŠŸ
        if (streak >= TARGET_POW) {
          bestStreak = Math.max(bestStreak, streak);
          localStorage.setItem('bestStreak', String(bestStreak));
          clears++;
          localStorage.setItem('clears', String(clears));
          showWin();
          updateUI();
          return;
        }
      } else {
        if (vibeOn && navigator.vibrate) navigator.vibrate([12, 35, 90]);
        beep(180, 120, 'sawtooth');
        flash(tryBtn, false);
        streak = 0;
      }

      bestStreak = Math.max(bestStreak, streak);
      localStorage.setItem('bestStreak', String(bestStreak));
      updateUI();
    }

    // ===== å‹åˆ©ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ =====
    function showWin() {
      winStats.textContent = `ç·ã‚¯ãƒªãƒƒã‚¯: ${attempts}ï½œé€£ç¶šæˆåŠŸ: ${streak}ï½œãƒ™ã‚¹ãƒˆé€£ç¶š: ${bestStreak}`;
      winOverlay.classList.add('show');
    }
    function hideWin() { winOverlay.classList.remove('show'); }

    // ===== ã‚¤ãƒ™ãƒ³ãƒˆ =====
    tryBtn.addEventListener('pointerdown', (e) => {
      e.preventDefault();
      judgeOnce();
    }, { passive: false });

    resetBtn.addEventListener('click', () => {
      attempts = 0; streak = 0;
      updateUI();
      hideWin();
      flash(tryBtn, true); // è»½ã„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    });

    soundBtn.addEventListener('click', () => {
      soundOn = !soundOn;
      localStorage.setItem('soundOn', soundOn ? '1' : '0');
      if (soundOn) ensureAudio();
      updateUI();
    });

    vibeBtn.addEventListener('click', () => {
      vibeOn = !vibeOn;
      localStorage.setItem('vibeOn', vibeOn ? '1' : '0');
      updateUI();
    });

    againBtn.addEventListener('click', () => {
      hideWin();
      attempts = 0;
      streak = 0;
      updateUI();
    });

    shareBtn.addEventListener('click', async () => {
      const text = `ã€Œ1/4096 ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã€ã‚¯ãƒªã‚¢ï¼é€£ç¶š${streak}å›ã€ç·ã‚¯ãƒªãƒƒã‚¯${attempts}å›`;
      const url = location.href;
      try {
        if (navigator.share) {
          await navigator.share({ text, url });
        } else {
          await navigator.clipboard.writeText(text + ' ' + url);
          shareBtn.textContent = 'ã‚³ãƒ”ãƒ¼ã—ãŸ';
          setTimeout(() => shareBtn.textContent = 'çµæœã‚’å…±æœ‰', 1400);
        }
      } catch (e) {
        /* noop */
      }
    });

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å¯¾å¿œï¼ˆPCå‘ã‘ï¼‰
    window.addEventListener('keydown', (e) => {
      if (e.code === 'Space' || e.code === 'Enter') {
        e.preventDefault();
        judgeOnce();
      }
      if (e.key === 'r') { attempts = 0; streak = 0; updateUI(); }
    });

    // åˆæœŸè¡¨ç¤º
    updateUI();
  </script>
</body>
</html>
